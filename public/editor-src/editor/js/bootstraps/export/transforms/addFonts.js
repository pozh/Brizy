/**
 * Parses the page and the css generated by glamor
 * and finds all inline font families that were used in it and appends them to head
 */

import {
  makeSubsetGoogleFontsUrl,
  makeRichTextFontGoogleCSS,
  makeUploadFontsUrl,
  makeRichTextFontUploadCSS
} from "visual/utils/fonts";

export default function addFonts($, { google, upload }) {
  generateGoogleAssets($, google);

  if (upload.length) {
    generateUploadAssets($, upload);
  }
}
function generateGoogleAssets($, fonts) {
  const fontsUrl = makeSubsetGoogleFontsUrl(
    fonts.filter(font => font.deleted !== true)
  );
  const richTextFamiliesCSS = makeRichTextFontGoogleCSS(fonts);

  $("head")
    .append(`<link type="text/css" rel="stylesheet" href="${fontsUrl}" />`)
    .append(`<style>${richTextFamiliesCSS}</style>`);
}

function generateUploadAssets($, fonts) {
  const fontsUrl = makeUploadFontsUrl(
    fonts.filter(font => font.deleted !== true)
  );
  const richTextFamiliesCSS = makeRichTextFontUploadCSS(fonts);

  $("head")
    .append(`<link type="text/css" rel="stylesheet" href="${fontsUrl}" />`)
    .append(`<style>${richTextFamiliesCSS}</style>`);
}
